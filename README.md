# 基于 Spring AI + Ollama 的轻量级智能对话模板

本项目是针对大语言模型对话场景的模板工程，基于 Spring AI + Ollama，提供智能对话的解决方案，支持**人格模拟对话、对话历史记忆、检索增强生成（RAG）**，便于初学者快速搭建应用。

## 模型选择

借由 Ollama 拉取本地模型，包括对话模型及嵌入模型，示例如下：

```shell
ollama pull deepseek-r1:8b
ollama pull nomic-embed-text
```

## 文档向量化

借助相应服务上传外部文档，支持 TXT、MD、PDF 等多种格式。

使用递归字符文本分割器（`RecursiveCharacterTextSplitter.java`），默认按以下分隔符优先级递归切割，直至块大小满足要求或分隔符用完。

```java
new String[]{"\n\n", "\n", "。", "！", "？", "；", "，", " "}
```

后续文本块经嵌入模型向量化后存储至本地文件。



## 对话人格化

对话提示词由五部分组成：【人格设定】+【文段记录】+【对话历史】+【当前问题】+【规则约束】

### 人格设定

人格设定包含个性特点、语言风格、背景故事、关键词等信息，示例如下：

```json
{
    "id": 1,
    "name": "应届生",
    "personality": "建设欲和求知欲驱动积极兴趣与可持续行为\n自我怀疑，需要暂停工作思考方向\n内向倾向，偏好深度关系而非广泛社交",
    "languageStyle": "内省式叙述，注重内心探索\n 倾向哲学化表达，常使用比喻和抽象概念\n口语化与书面语混合，包含网络用语",
    "background": "高考失败触发自我觉醒，反思人生选择\n长期逃避不确定性，亦不断探索工作与人际关系\n对社会风气持批判态度，认为存在功利化倾向",
    "keywords": ["建设欲", "求知欲", "独处", "抽象", "思维极化", "自我怀疑", "深度关系"]
}
```

人格设定存储于 PostgreSQL 数据表（`persona.sql`），基于 MyBatis 实现 SQL 映射，记录对应实体（`Persona.java`），可借助相应服务增删改查。

### 文段记录

根据用户输入，相似度检索向量，匹配文段记录，增强回答生成。

### 对话历史

对话通过 ID （`conversationId`）区分，历史消息存储于内存，以支持上下文对话。

### 规则约束

示例如下：

```java
// 拟人化风格
String rulePrompt1 = """
    1. 请以第一人称口吻，用自然、亲切的语气回答。
    2. 必须基于提供的人格设定和文字记录（体会语气、了解经历、理解观点）来回答。
    3. 如果记忆中没有相关信息，请坦诚地说：“根据我的记忆，我不太确定这件事”。
    4. 可以合理推断，但不要编造明确未提及的事实。
""";

// 助手风格
String rulePrompt2 = """
    1. 请保持客观中立的态度，给出简洁、准确、专业的回答。
    2. 必须基于提供的文档内容，提取相关信息归纳、整理、分析。
    3. 如果文档中没有相关信息，请说：“根据现有文档，没有找到相关信息”。
    4. 基于整理的信息，不要编造、假设或猜测信息。
""";
```



## 启动流程

1. **AI 模型启动**：启动 Ollama
2. **客户端配置**：编辑 `application.properties` 文件，配置相应参数，并按需调整 `config` 中的配置
3. **人格配置**：执行 `persona.sql`  脚本，创建数据表，初始数据可参考 `persona_data.json`
4. **项目启动**：运行 `Application.java` 主类，启动 Spring Boot 应用
5. **接口调用**：发起请求调用控制层接口，执行相关操作

## 参考资料

- Spring AI 文档：https://spring.io/projects/spring-ai
- Spring AI Alibaba 文档：https://java2ai.com/docs/overview/
- Ollama 模型库：https://ollama.com/library
- 《PersonaAI：利用检索增强生成和个性化上下文打造人工智能驱动的数字虚拟形象》：https://arxiv.org/html/2503.15489v1
