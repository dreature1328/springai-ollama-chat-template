<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="xyz.dreature.soct.mapper.PersonaMapper">

    <!-- ===== 结果映射配置 ===== -->
    <resultMap id="personaMap" type="xyz.dreature.soct.common.model.entity.Persona">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="personality" column="personality"/>
        <result property="languageStyle" column="language_style"/>
        <result property="background" column="background"/>
        <result property="keywords" column="keywords"
                typeHandler="arrayTypeHandler"/>
    </resultMap>

    <!-- ===== 复用 SQL 片段 ===== -->
    <sql id="table">persona</sql>
    <sql id="columns">
        id, name, personality, language_style, background, keywords
    </sql>

    <sql id="values">
        #{id}, #{name}, #{personality}, #{languageStyle}, #{background},
        #{keywords, typeHandler=arrayTypeHandler}
    </sql>

    <sql id="itemValues">
        #{item.id}, #{item.name}, #{item.personality}, #{item.languageStyle}, #{item.background},
        #{item.keywords, typeHandler=arrayTypeHandler}
    </sql>

    <sql id="set">
        name = #{name},
        personality = #{personality},
        language_style = #{languageStyle},
        background = #{background},
        keywords = #{keywords, typeHandler=arrayTypeHandler}
    </sql>

    <sql id="conflictSet">
        name = EXCLUDED.name,
        personality = EXCLUDED.personality,
        language_style = EXCLUDED.language_style,
        background = EXCLUDED.background,
        keywords = EXCLUDED.keywords
    </sql>

    <!-- ===== 基础CRUD操作 ===== -->
    <select id="selectById" parameterType="long" resultMap="personaMap">
        SELECT <include refid="columns"/>
        FROM <include refid="table"/>
        WHERE id = #{id}
    </select>

    <select id="selectBatchByIds" resultMap="personaMap">
        SELECT <include refid="columns"/>
        FROM <include refid="table"/>
        WHERE id IN
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <insert id="insert" parameterType="xyz.dreature.soct.common.model.entity.Persona">
        INSERT INTO <include refid="table"/>
        (<include refid="columns"/>)
        VALUES (<include refid="values"/>)
    </insert>

    <insert id="insertBatch" parameterType="list">
        INSERT INTO <include refid="table"/>
        (<include refid="columns"/>)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (<include refid="itemValues"/>)
        </foreach>
    </insert>

    <update id="update" parameterType="xyz.dreature.soct.common.model.entity.Persona">
        UPDATE <include refid="table"/>
        SET <include refid="set"/>
        WHERE id = #{id}
    </update>

    <update id="updateBatch" parameterType="list">
        UPDATE <include refid="table"/>
        SET
        name = CASE
        <foreach collection="list" item="item">
            WHEN id = #{item.id} THEN #{item.name}
        </foreach>
        END,
        personality = CASE
        <foreach collection="list" item="item">
            WHEN id = #{item.id} THEN #{item.personality}
        </foreach>
        END,
        language_style = CASE
        <foreach collection="list" item="item">
            WHEN id = #{item.id} THEN #{item.languageStyle}
        </foreach>
        END,
        background = CASE
        <foreach collection="list" item="item">
            WHEN id = #{item.id} THEN #{item.background}
        </foreach>
        END,
        keywords = CASE
        <foreach collection="list" item="item">
            WHEN id = #{item.id} THEN #{item.keywords, typeHandler=arrayTypeHandler}
        </foreach>
        END
        WHERE id IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item.id}
        </foreach>
    </update>

    <insert id="upsert" parameterType="xyz.dreature.soct.common.model.entity.Persona">
        INSERT INTO <include refid="table"/>
        (<include refid="columns"/>)
        VALUES (<include refid="values"/>)
        ON CONFLICT (id) DO UPDATE
        SET <include refid="conflictSet"/>
    </insert>

    <insert id="upsertBatch" parameterType="list">
        INSERT INTO <include refid="table"/>
        (<include refid="columns"/>)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (<include refid="itemValues"/>)
        </foreach>
        ON CONFLICT (id) DO UPDATE
        SET <include refid="conflictSet"/>
    </insert>

    <delete id="deleteById" parameterType="long">
        DELETE FROM <include refid="table"/>
        WHERE id = #{id}
    </delete>

    <delete id="deleteBatchByIds" parameterType="list">
        DELETE FROM <include refid="table"/>
        WHERE id IN
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>

    <!-- 清空 -->
    <update id="truncate">
        TRUNCATE TABLE <include refid="table"/> RESTART IDENTITY
    </update>
</mapper>
